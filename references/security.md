# Odoo Security Reference

## Table of Contents
- [Access Control Overview](#access-control-overview)
- [Security Groups](#security-groups)
- [Access Rights (ir.model.access.csv)](#access-rights)
- [Record Rules (ir.rule)](#record-rules)
- [Field-Level Access](#field-level-access)
- [Superuser and Sudo](#superuser-and-sudo)

## Access Control Overview

Odoo security has three layers:
1. **Groups** — Define user roles
2. **Access Rights** (ir.model.access) — Model-level CRUD permissions per group
3. **Record Rules** (ir.rule) — Row-level filtering per group

## Security Groups

Define in XML data files:

```xml
<!-- security/security.xml -->
<odoo>
    <record id="group_library_user" model="res.groups">
        <field name="name">Library User</field>
        <field name="category_id" ref="base.module_category_services"/>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]"/>
    </record>

    <record id="group_library_manager" model="res.groups">
        <field name="name">Library Manager</field>
        <field name="category_id" ref="base.module_category_services"/>
        <field name="implied_ids" eval="[(4, ref('group_library_user'))]"/>
        <field name="users" eval="[(4, ref('base.user_root')), (4, ref('base.user_admin'))]"/>
    </record>
</odoo>
```

### `implied_ids` (Group Inheritance)

`implied_ids` means "users in this group automatically get the implied groups too."

- Manager implies User: managers get all user permissions automatically.
- Use `eval="[(4, ref('group_id'))]"` to add implied groups.

## Access Rights

File: `security/ir.model.access.csv`

```csv
id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
access_library_book_user,library.book.user,model_library_book,group_library_user,1,1,1,0
access_library_book_manager,library.book.manager,model_library_book,group_library_manager,1,1,1,1
access_library_book_category_user,library.book.category.user,model_library_book_category,group_library_user,1,0,0,0
access_library_book_category_manager,library.book.category.manager,model_library_book_category,group_library_manager,1,1,1,1
```

### Naming Convention

- `id`: `access_{model_name_underscored}_{group_short_name}`
- `model_id:id`: `model_{model_name_dots_to_underscores}` (auto-generated by Odoo from `_name`)

### Rules

- Every model **must** have at least one access rule, or users get "Access Denied."
- A group with no row means no access for that group.
- Leave `group_id:id` empty for public access (rare, avoid).

## Record Rules

Row-level security — filter which records a group can access:

```xml
<!-- security/security.xml -->
<record id="rule_library_book_user" model="ir.rule">
    <field name="name">Library Book: User sees own company</field>
    <field name="model_id" ref="model_library_book"/>
    <field name="domain_force">[('company_id', 'in', company_ids)]</field>
    <field name="groups" eval="[(4, ref('group_library_user'))]"/>
    <field name="perm_read" eval="True"/>
    <field name="perm_write" eval="True"/>
    <field name="perm_create" eval="True"/>
    <field name="perm_unlink" eval="False"/>
</record>
```

### Global Rules (no group)

When `groups` is empty, the rule applies to ALL users (cannot be bypassed by group membership):

```xml
<record id="rule_library_book_global" model="ir.rule">
    <field name="name">Library Book: Active only</field>
    <field name="model_id" ref="model_library_book"/>
    <field name="domain_force">[('active', '=', True)]</field>
    <field name="groups" eval="[(5,)]"/>  <!-- empty = global -->
</record>
```

### Multi-company Record Rule

```xml
<record id="rule_library_book_multi_company" model="ir.rule">
    <field name="name">Library Book: Multi-company</field>
    <field name="model_id" ref="model_library_book"/>
    <field name="domain_force">[('company_id', 'in', company_ids)]</field>
    <field name="groups" eval="[(4, ref('base.group_user'))]"/>
</record>
```

## Field-Level Access

Restrict field visibility to specific groups:

```python
secret_notes = fields.Text(groups='library_management.group_library_manager')
```

In views:

```xml
<field name="secret_notes" groups="library_management.group_library_manager"/>
```

## Superuser and Sudo

```python
# Execute as superuser (bypasses all access rights and record rules)
self.env['library.book'].sudo().search([])

# Execute as a specific user
self.env['library.book'].with_user(user_id).search([])
```

**Warning:** Use `sudo()` sparingly. Always validate data before writing with `sudo()`.
